#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const PROMPT_DIR = '.prompts';
const BASE_TEMPLATE = path.join(__dirname, '../templates/base_prompt.md');
const LOCAL_BASE = path.join(process.cwd(), PROMPT_DIR, 'base_prompt.md');

// Create .prompts folder if it doesn't exist
if (!fs.existsSync(PROMPT_DIR)) fs.mkdirSync(PROMPT_DIR);

// Copy base template the very first time
if (!fs.existsSync(LOCAL_BASE)) {
  fs.copyFileSync(BASE_TEMPLATE, LOCAL_BASE);
  console.log("âš™ï¸  base_prompt.md copied to your project");
}

function askForLastThing() {
  rl.question("\nWhatâ€™s the last thing you remember doing in this folder? ðŸ¤”\n> ", (lastThing) => {
    if (!lastThing.trim()) {
      console.log("Come on, tell me something! ðŸ˜œ");
      askForLastThing();
      return;
    }

    askForPromptName(lastThing.trim());
  });
}

function askForPromptName(lastThing) {
  rl.question("\nGive this prompt a short name (e.g. 'add login', 'fix navbar', 'new feature'): ", (input) => {
    if (!input.trim()) {
      console.log("You gotta give it a name, dude!");
      askForPromptName(lastThing);
      return;
    }

    // â”€â”€â”€ Generate filename â”€â”€â”€
    const slug = input
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");

    const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
    const today = fs.readdirSync(PROMPT_DIR).filter(f => f.startsWith(date));
    const count = String(today.length + 1).padStart(2, '0');
    const filename = `${date}_${count}_${slug}.md`;
    const fullpath = path.join(PROMPT_DIR, filename);

    // â”€â”€â”€ Create the file and inject the title + history â”€â”€â”€
    fs.copyFileSync(LOCAL_BASE, fullpath);

    let content = fs.readFileSync(fullpath, 'utf8');

    // Replace the title (assuming template has "# " or "# Title" at the top)
    content = content.replace(/^#.*$/m, `# ${lastThing}`);

    // Add to History section (create it if it doesn't exist)
    const historyEntry = `${today.length + 1}. ${lastThing}`;
    if (content.includes("## History")) {
      content = content.replace(/(## History\s*)([\s\S]*)/, `$1\n- ${historyEntry}\n$2`);
    } else {
      content += `\n\n## History\n\n- ${historyEntry}\n`;
    }

    fs.writeFileSync(fullpath, content);

    // â”€â”€â”€ Victory message â”€â”€â”€
    console.log("\nPrompt created! ðŸŽ‰\n");
    console.log(`Title â†’ "${lastThing}"`);
    console.log(`File  â†’ ${filename}`);
    console.log(`Path  â†’ ${fullpath}\n`);

    rl.close();
  });
}

console.log("\ncreate-prompt v1.1.0 â€“ now with memory! ðŸ§ \n");
askForLastThing();