#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const PROMPT_DIR = '.prompts';
const BASE_TEMPLATE = path.join(__dirname, '../templates/base_prompt.md');
const LOCAL_BASE = path.join(process.cwd(), PROMPT_DIR, 'base_prompt.md');

// Crear carpeta .prompts si no existe
if (!fs.existsSync(PROMPT_DIR)) fs.mkdirSync(PROMPT_DIR, { recursive: true });

// Copiar template base la primera vez
if (!fs.existsSync(LOCAL_BASE)) {
  fs.copyFileSync(BASE_TEMPLATE, LOCAL_BASE);
  console.log("base_prompt.md copied to your project");
}

function askForLastThing() {
  rl.question("\nWhat’s the last thing you remember doing in this folder? \n> ", (lastThing) => {
    if (!lastThing.trim()) {
      console.log("Hey, don’t leave me hanging! Tell me something ");
      askForLastThing();
      return;
    }

    askForPromptName(lastThing.trim());
  });
}

function askForPromptName(lastThing) {
  rl.question("\nGive this prompt a short name (e.g. 'fix login', 'add dark mode'): ", (input) => {
    if (!input.trim()) {
      console.log("Gotta name it, bro!");
      askForPromptName(lastThing);
      return;
    }

    // Generate slug for filename
    const slug = input
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");

    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const todayFiles = fs.readdirSync(PROMPT_DIR).filter(f => f.startsWith(date));
    const count = String(todayFiles.length + 1).padStart(2, '0');
    const filename = `${date}_${count}_${slug}.md`;
    const fullpath = path.join(PROMPT_DIR, filename);

    // Copy template
    fs.copyFileSync(LOCAL_BASE, fullpath);

    // Read and modify content
    let content = fs.readFileSync(fullpath, 'utf8');

    // 1. Set main title
    content = content.replace(/^#.*$/m, `# ${lastThing}`);

    // 2. Add to History with "- " (bullet style)
    const historyLine = `- ${lastThing}`;

    if (content.includes("## History")) {
      // Insert new entry right after "## History" line
      content = content.replace(
        /(## History\s*\n)/,
        `$1${historyLine}\n`
      );
    } else {
      // Create History section at the end
      content += `\n\n## History\n\n${historyLine}\n`;
    }

    fs.writeFileSync(fullpath, content);

    // Victory dance
    console.log("\nPrompt created! \n");
    console.log(`Title → "${lastThing}"`);
    console.log(`File  → ${filename}`);
    console.log(`Path  → ${fullpath}\n`);

    rl.close();
  });
}

console.log("\ncreate-prompt v1.2.0 – now with clean bullet history! \n");
askForLastThing();